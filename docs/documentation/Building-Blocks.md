# Building Blocks

The solution comprises of the following building blocks:

## **1. DynamoDB tables**

| Table Name         | Contents                                                                   | Use                                                                                                                                                                                         | Streams enabled |
| ------------------ | -------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------- |
| Permission Set     | All content of permission set JSON files                                   | Staging - to compute delta while triggering permission set create/update/delete API                                                                                                         | Yes             |
| Permission Set Arn | Permission set name and arn value (generated by SSO on create API call)    | Lookup - to map permission set name to arn value and vice versa                                                                                                                             | No              |
| Links              | All content of links file name split by dot (excluding the file extension) | Lookup - fetch one link entity value based on another entity value Lookup, determine pre-existing account assignment relationships Trigger - create/delete accountAssignment based on data changes | Yes             |
| Groups             | Group name and group GUID value(generated by SSO on create group API call) | Lookup - map group name to group GUID Trigger - create/delete accountAssignment based on data changes Trigger - create/delete accountAssignment based on data changes                       | No              |
| Provisioned Links  | Link data abstracted to an individual account                              | Lookup - used to determine if a link has already been created                                                                                                                               | No              |

## **2. Lambda Functions**

| Function                             | Invoked by                                                                                                                                          | Purpose                                                                                                                                                                                                     |
| ------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Permission set create/update handler | S3 object event notifications listening on permission set prefix and create object type events                                                      | Update permission set table with the required changes                                                                                                                                                       |
| Permission set delete handler        | S3 object event notifications listening on permission set prefix and remove object type events                                                      | Update permission set table with the required changes, validate and enforce "cannot delete" constraint in case permission set is referenced in an account assignment                                          |
| Permission set stream handler        | Permission set table streams for OLD_AND_NEW_IMAGES                                                                                                 | Compute the change and post it to permission set topic                                                                                                                                                      |
| Link create/update handler           | S3 object event notifications listening on link prefix and create object type events                                                                | Update links table with the required changes                                                                                                                                                                |
| Link delete handler                  | S3 object event notifications listening on link prefix and remove object type events                                                                | Update links table with the required changes                                                                                                                                                                |
| Link stream handler                  | Link table streams for OLD_AND_NEW_IMAGES                                                                                                           | validate if link is ready to be provisioned/de-provisioned (check permissionset and group status)and if it needs expansion for ou/org wide types and then post to links topic                               |
| Permission set topic                 | Invoked by a new message posted to permission set topic                                                                                             | Compute the delta for the permission set, call SSO API with the correct method and delta, trigger re-provision if necessary , let waiter know of this re-provision request                                  |
| Links topic                          | Invoked by a new message posted to links topic                                                                                                      | Validate the link status looking up in the provisioned links table and perform create/delete based on the lookup results, let waiter know of this create/delete request                                     |
| Group handler                        | Invoked by cloudwatch event rule matching CreateGroup, DeleteGroup event names using sso-directory as the event source                              | Create/delete the group name to groupId mapping in groups table and look up if the creation/deletion of the group impacts any links, expand for ou/org wide types if necessary and then post to links topic |
| Org event handler                    | Invoked by cloudwatch event rule matching CreateAccount, MoveAccount and Tag Change on resource event names using Organizations as the event source | Look up if the creation/move of the account impacts any links, expand for ou/org wide types if necessary and then post to links topic                                                                       |
| Permission set API handler           | Incoming Rest API call on the API gateway end point                                                                                                 | Provide the same functionality as permission set create/update handler plus delete handler                                                                                                                  |
| Link API handler                     | Incoming Rest API call on the API gateway end point                                                                                                 | Provide the same functionality as link create/update handler plus delete handler                                                                                                                            |
| Waiter handler                       | Invoked by a new message posted to waiter topic                                                                                                     | Wait until the request reaches Success, failure or max attempt and then feedback if error                                                                                                                   |
| Permission set sync handler          | Invoked by a new message posted to permission set sync topic                                                                                        | Handle out of band permission set life cycle management                                                                                                                                                     |
| State machine listener handler       | Invoked by state machine in org account                                                                                                             | Handle account assignment creation/deletion based on state machine payload                                                                                                                                  |

## **3. SNS Topics**

| Topic                     | Publisher                                                                | Subscriber                       | Purpose                                                                        |
| ------------------------- | ------------------------------------------------------------------------ | -------------------------------- | ------------------------------------------------------------------------------ |
| Permission set topic      | Permission set stream handler lambda                                     | Permission set topic lambda      | Fan out permission set changes to scale for load                               |
| Permission set sync topic | Permission set stream handler lambda                                     | Permission set sync topic lambda | Handle permission set synchronisation to trigger any pending link provisioning |
| Links topic               | Link stream handler lambda Group handler lambda Org event handler lambda | Links topic lambda               | Fan out link creation/deletion changes to scale for load                       |
| Error topic               | All lambda functions                                                     | Email provided in cdk.json       | Common error notifier across all operations                                    |
| Waiter topic              | Permission set topic handler and link manager handler                    | Waiter lambda                    | Fan out asynchronous operation status check flows                              |
| State machine topic       | All account assignment lambda handlers dealing with non account scope    | state machine listener lambda    | Process state machine response payload for non account scope types             |

## **4. S3 Object Event Notifications**

| S3 Bucket            | Prefix Filtered on | Suffix filtered on | Lambda invoked                                                                                                             |
| -------------------- | ------------------ | ------------------ | -------------------------------------------------------------------------------------------------------------------------- |
| SSO artefacts bucket | permission_sets/   | .json              | OBJECT_CREATED event type - Permission set create/update handler OBJECT_REMOVED event type - Permission set delete handler |
| SSO artefacts bucket | links_data/        | .ssofile           | OBJECT_CREATED event type - link create/update handler OBJECT_REMOVED event type - link delete handler                     |

## **5. API Gateway end points**

| API Name           | Type | Integration | Authentication                                                          | Purpose                                | Receiver                 |
| ------------------ | ---- | ----------- | ----------------------------------------------------------------------- | -------------------------------------- | ------------------------ |
| Links API          | Edge | Lambda Rest | IAM with permissions set to links api caller roleArn from cdk.json      | Interface for linkAPI handler          | linkAPI handler          |
| Permission set API | Edge | Lambda Rest | IAM with permissions set to permission set caller roleArn from cdk.json | Interface for permissionSetAPI handler | permissionSetAPI handler |

## **6. State Machines**

| Step function Name      | Deployed in                | Invoked by                                                                           | Purpose                                       | End state                                        |
| ----------------------- | -------------------------- | ------------------------------------------------------------------------------------ | --------------------------------------------- | ------------------------------------------------ |
| Process target accounts | Org main account us-east-1 | All account assignment creation/deletion lambdas dealing with non account scope type | Resolve target accounts by querying org API's | Post resolved accounts payload to listener topic |

## **7. Lambda Layers**

| Layer Name    | Runtime     | Purpose                                                        | Referenced by              |
| ------------- | ----------- | -------------------------------------------------------------- | -------------------------- |
| Node JS layer | NODEJS_12_X | Package AWS-JS SDK V3 modular clients and dynamodb diff mapper | All Lambda's except waiter |
| Python layer  | PYTHON_3_8  | Package required botocore and boto3 versions                   | Waiter                     |
